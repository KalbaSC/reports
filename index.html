<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
    <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>لوحة حضور المخيم الصيفي - نادي كلباء</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic.ttf') format('truetype');
    }
    body {
      font-family: 'NotoKufiArabic', sans-serif;
      background: url('black_and_yellow_grunge_background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      margin: 0;
      padding: 0;
    }
.header-container {
  width: 100%;
  background: #111;
  border-bottom: 2px solid #f4e733;
}
.header-right {
  width: 100%;
  max-width: 1170px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 20px 42px;
  background-color: #111;
  color: white;
  box-sizing: border-box;
}
.header-right img.logo {
  height: 70px;
}
.divider {
  width: 1.5px;
  height: 65px;
  background-color: #f4e733;
}
.header-info {
  text-align: center;
}
.arabic-name {
  font-weight: bold;
  font-size: 20px;
      font-weight: bold;
}
.english-name {
  font-size: 14px;
  color: #f4e733;
}

    nav {
      background-color: #111;
      display: flex;
      justify-content: space-around;
      border-bottom: 3px solid #f4e733;
      border-top: 1px solid #f4e733;
    }
    nav button {
      flex: 1;
      background: none;
      border: none;
      color: #f4e733;
      font-size: 18px;
      padding: 15px;
      cursor: pointer;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 10px;
      margin-top: 30px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 15px;
      border-radius: 10px;
    }
    .controls input {
      padding: 10px;
      border-radius: 5px;
      margin: 5px;
    }
    .summary-box {
  display: flex;
  gap: 15px;
  align-items: center;
  color: #f4e733;
  font-weight: bold;
}
    
.search-group {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  width: 100%;
  gap: 10px;
}

.search-group input {
  flex: 1;
  min-width: 0;
  box-sizing: border-box;
}
   
.export-buttons {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

    .controls .summary-box {
      display: flex;
      gap: 15px;
      align-items: center;
      color: #f4e733;
      font-weight: bold;
      margin: 5px;
    }
    button.export {
      background: #f4e733;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #f4e733;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #f4e733;
    }
    .download-icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background: black;
  clip-path: polygon(50% 0%, 100% 50%, 75% 50%, 75% 100%, 25% 100%, 25% 50%, 0% 50%);
  margin-left: 5px;
  vertical-align: middle;
}
           footer {
      background-color: #111;
      color: white;
      text-align: center;
      padding: 20px;
      border-top: 3px solid #f4e733;
      font-size: 14px;
    }

    .social-icons a {
      color: white;
      margin: 0 8px;
      font-size: 20px;
    }
    #datePicker {
  background: white;
  color: black;
  border: none;
  padding: 10px;
  border-radius: 5px;
}
    @media (max-width: 768px) {
 .header-right {
    padding: 10px 10px;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .header-info {
    display: block;
    text-align: center;
  }

  .header-info .arabic-name {
    font-size: 16px;
  }

  .header-info .english-name {
    font-size: 12px;
  }

  .header-right .divider {
    height: 45px;
    width: 1.5px;
    background-color: #f4e733;
  }

  img.logo {
    height: 50px !important;
    max-height: 50px !important;
  }
  nav button {
    flex: 1 1 50%;
    font-size: 15px;
    padding: 10px;
  }

  .container {
    padding: 12px;
    margin: 10px auto;
    width: 95%;
  }

  .title {
    font-size: 18px;
    margin-top: 15px;
    margin-bottom: 17px;
    line-height: 1.4;
  }

      .search-group {
  flex-direction: row !important;
  flex-wrap: nowrap;
}

.search-group input {
  width: 100%;
  flex: 1;
}
      .download-icon {
  width: 14px;
  height: 14px;
  margin-left: 4px;
}

  .controls {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .controls input {
    width: 100%;
    padding: 8px;
    font-size: 14px;
    margin: 2px 0;
  }

  button.export {
    width: 80%;
    font-size: 12px;
    align-items: center;
    padding: 10px;
  }

  .summary-box {
    text-align: center;
    font-size: 14px;
  }

  table {
    display: block;
    overflow-x: auto;
    font-size: 13px;
  }

  th, td {
    padding: 6px;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }

  footer {
  text-align: center;
  padding: 15px 10px;
}

footer p {
  margin-bottom: 10px;
  font-size: 13px;
}

.social-icons {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
}
  .social-icons a {
    font-size: 18px;
  }
}
  </style>
</head>
<body>
  <header class="header-container">
  <div class="header-right">
    <img src="Picture3.png" alt="شعار الشارقة" class="logo">
    <div class="divider"></div>
    <img src="logo.png" alt="شعار نادي كلباء" class="logo">
    <div class="header-info">
      <div class="arabic-name">نادي كلباء الرياضي الثقافي</div>
      <div class="english-name">KALBA SPORTS & CULTURAL CLUB</div>
    </div>
  </div>
</header>

  <nav>
    <button onclick="filterData('day')">اليوم</button>
    <button onclick="filterData('week')">هذا الأسبوع</button>
    <button onclick="filterData('month')">هذا الشهر</button>
    <button onclick="showStats()">الإحصائيات</button>
  </nav>

<div class="container" id="mainView">
  <div class="title" style="color: #f4e733; text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 25px;">
    حضور صيف الشارقة الرياضي - عطلتنا غير
  </div>

  <div class="controls">
    
<div class="search-group">
  <input type="text" id="searchName" placeholder="بحث بالاسم..." onkeyup="filterTable()">
  <input type="text" id="searchGame" placeholder="بحث بالموظف المسؤول..." onkeyup="filterTable()">
  <input type="text" id="searchActivity" placeholder="بحث بالنشاط..." onkeyup="filterTable()">
  <input type="date" id="datePicker" onchange="filterByDate()" />
  <button onclick="clearFilters()" style="padding:10px; background:#f4e733; color:black; border:none; border-radius:8px;">مسح البحث</button>
</div>

<div class="export-buttons">
  <button class="export" onclick="exportToExcel()">
    <span class="download-icon"></span> Excel
  </button>
  <button class="export" onclick="exportToPDF()">
    <span class="download-icon"></span> PDF
  </button>
</div>

    <div class="summary-box">
      <span id="summary">إجمالي الحضور: 0</span>
      <span id="filteredSummary"></span>
    </div>
  </div>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>الوقت</th>
          <th>الاسم</th>
          <th>ولي الأمر</th>
          <th>المعرف</th>
          <th>الموظف</th>
          <th>الحضور العام</th>
          <th>النشاط</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  
  <div id="todayStats" style="background:#222; padding:20px; border-radius:10px; margin-top:20px; color:#f4e733">
  <h3 style="margin-bottom:15px;">إحصاءات اليوم:</h3>
  <div id="staffToday"></div>
  <div id="timingToday" style="margin-top:10px;"></div>
</div>

</div>


  <div class="container" id="statsView" style="display: none;">
    <h2 style="color:#f4e733; text-align:center">إحصائيات الحضور</h2>
    <canvas id="pieStaff" height="200"></canvas>
    <canvas id="earlyLate" height="200"></canvas>
    <canvas id="attendanceChart" height="200"></canvas>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxij6xIH_fypPRhklqQKURq-7xB5RJ3sC5dCBfwj4sJBjqnfXde1ncFrhCpDy04zuZW6g/exec';
    let allData = [], chart;

    async function fetchData() {
      const res = await fetch(scriptURL);
      allData = await res.json();

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("datePicker").value = today;
      filterByDate();
    }

    function filterData(type) {
      document.getElementById("mainView").style.display = "block";
      document.getElementById("statsView").style.display = "none";
      const now = new Date();
      let filtered = allData.filter(row => {
        const d = new Date(row["Timestamp"]);
        if (type === 'day') return d.toDateString() === now.toDateString();
        if (type === 'week') {
          const start = new Date(now); start.setDate(now.getDate() - 7);
          return d >= start && d <= now;
        }
        if (type === 'month') return d.getMonth() === now.getMonth();
        return true;
      });
      renderTable(filtered);
    }
function filterByDate() {
  const selectedDate = document.getElementById("datePicker").value;
  if (!selectedDate) return;

  const filtered = allData.filter(row => {
    const rowDate = new Date(row["Timestamp"]).toISOString().split("T")[0];
    return rowDate === selectedDate;
  });

  document.getElementById("mainView").style.display = "block";
  document.getElementById("statsView").style.display = "none";
  renderTable(filtered);
}
    function showStats() {
      document.getElementById("mainView").style.display = "none";
      document.getElementById("statsView").style.display = "block";
      const staffCounts = {}, early = { early: 0, late: 0 };

      allData.forEach(row => {
        const name = row["Scanned By"] || "غير معروف";
        staffCounts[name] = (staffCounts[name] || 0) + 1;
        const hour = new Date(row["Timestamp"]).getHours();
        const min = new Date(row["Timestamp"]).getMinutes();
        const time = hour * 60 + min;
        if (time < (17 * 60 + 11)) early.early++;
        else early.late++;
      });

      new Chart(document.getElementById("pieStaff").getContext("2d"), {
        type: 'pie',
        data: {
          labels: Object.keys(staffCounts),
          datasets: [{
            data: Object.values(staffCounts),
            backgroundColor: ['#f4e733', '#ffbb00', '#ffaa00', '#ccaa00', '#999900']
          }]
        }
      });

      new Chart(document.getElementById("earlyLate").getContext("2d"), {
        type: 'bar',
        data: {
          labels: ['حضور بالوقت', 'حضور متأخر'],
          datasets: [{
            data: [early.early, early.late],
            backgroundColor: ['#66cc66', '#cc3333']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      const perDay = {};
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(row["Timestamp"]).toLocaleString('ar-EG')}</td>
          <td>${row["Child Name"]}</td>
          <td>${row["Parent"]}</td>
          <td>${row["ID"]}</td>
          <td>${row["Scanned By"]}</td>
          <td>${row["General"] || ""}</td>
          <td>${row["Activity"] || ""}</td>`;
        tbody.appendChild(tr);
        const day = new Date(row["Timestamp"]).toLocaleDateString('ar-EG');
        perDay[day] = (perDay[day] || 0) + 1;
      });
      document.getElementById("summary").innerText = `إجمالي الحضور: ${data.length}`;
      document.getElementById("filteredSummary").innerText = "";
      updateChart(perDay);
      // إحصاءات اليوم (صندوق صغير)
const staffToday = {};
let early = 0, late = 0;
data.forEach(row => {
  const name = row["Scanned By"] || "غير معروف";
  staffToday[name] = (staffToday[name] || 0) + 1;

  const time = new Date(row["Timestamp"]);
const hours = time.getHours();
const minutes = time.getMinutes();
const totalMinutes = hours * 60 + minutes;

// ✅ نعتبر قبل 17:11 (5:11 مساءً) "بالوقت"
if (totalMinutes < (17 * 60 + 11)) early++;
else late++;
});

const staffList = Object.entries(staffToday)
  .map(([name, count]) => `${name}: ${count}`)
  .join("<br>");

document.getElementById("staffToday").innerHTML = `<strong>حسب الموظف:</strong><br>${staffList}`;
document.getElementById("timingToday").innerHTML = `<strong>حسب الوقت:</strong><br>بالوقت: ${early} | متأخر: ${late}`;
    }

    function filterTable() {
      const name = document.getElementById("searchName").value.toLowerCase();
      const game = document.getElementById("searchGame").value.toLowerCase();
      const activity = document.getElementById("searchActivity").value.toLowerCase();
      const rows = document.querySelectorAll("#attendanceTable tbody tr");

      let visibleCount = 0;
rows.forEach(row => {
  const nameCell = row.cells[1].innerText.toLowerCase();
  const gameCell = row.cells[4].innerText.toLowerCase();
  const activityCell = row.cells[6]?.innerText.toLowerCase() || "";

  const match = nameCell.includes(name) &&
                gameCell.includes(game) &&
                activityCell.includes(activity);

  row.style.display = match ? "" : "none";
  if (match) visibleCount++;
      });

    document.getElementById("filteredSummary").innerText =
    (name || game || activity) ? `عدد النتائج المطابقة: ${visibleCount}` : "";
    }

function clearFilters() {
  document.getElementById("searchName").value = "";
  document.getElementById("searchGame").value = "";
  document.getElementById("searchActivity").value = "";
  filterTable(); 
}
    function exportToExcel() {
      const wb = XLSX.utils.table_to_book(document.getElementById("attendanceTable"));
      XLSX.writeFile(wb, "attendance.xlsx");
    }

function exportToPDF() {
    const rows = document.querySelectorAll("#attendanceTable tbody tr");
  if (rows.length === 0) {
    alert("لا يوجد بيانات لتصديرها إلى PDF");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  const table = document.querySelector("#attendanceTable");

  // إزالة أي قيود على overflow لتظهر البيانات
  table.style.overflow = "visible";

  html2canvas(table, {
    scale: 2,
    backgroundColor: "#000000", // ضروري لأن خلفيتك داكنة
    useCORS: true
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let position = 10;
    let heightLeft = imgHeight;

    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      doc.addPage();
      doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    doc.save("attendance.pdf");
  });
}  
    
    function updateChart(dayCounts) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(dayCounts),
          datasets: [{
            label: 'عدد الحضور اليومي',
            data: Object.values(dayCounts),
            backgroundColor: '#f4e733',
            borderColor: '#000',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    fetchData();
  </script>
  <footer>
  <p>© 2025 نادي كلباء الرياضي الثقافي - جميع الحقوق محفوظة</p>
    <p style="font-size: 14px; color: #aaa; margin-top: -10px;">تم التطوير بواسطة روند أحمد الضمور</p>
  <div class="social-icons">
    <a href="https://facebook.com/Kalbasc1" target="_blank"><i class="fab fa-facebook-f"></i></a>
    <a href="https://instagram.com/kalbasc" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://x.com/Kalba_sc" target="_blank"><i class="fab fa-twitter"></i></a>
    <a href="https://youtube.com/@kalbasc" target="_blank"><i class="fab fa-youtube"></i></a>
    <a href="https://tiktok.com/@kalbasc" target="_blank"><i class="fab fa-tiktok"></i></a>
  </div>
</footer>
</body>
</html>
