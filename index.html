<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
    <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>لوحة حضور المخيم الصيفي - نادي كلباء</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic.ttf') format('truetype');
    }
    body {
      font-family: 'NotoKufiArabic', sans-serif;
      background: url('black_and_yellow_grunge_background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      margin: 0;
      padding: 0;
    }
.header-container {
  width: 100%;
  background: #111;
  border-bottom: 2px solid #f4e733;
}
.header-right {
  width: 100%;
  max-width: 1170px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 20px 42px;
  background-color: #111;
  color: white;
  box-sizing: border-box;
}
.header-right img.logo {
  height: 70px;
}
.divider {
  width: 1.5px;
  height: 65px;
  background-color: #f4e733;
}
.header-info {
  text-align: center;
}
.arabic-name {
  font-weight: bold;
  font-size: 20px;
      font-weight: bold;
}
.english-name {
  font-size: 14px;
  color: #f4e733;
}
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 10px;
      margin-top: 30px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 15px;
      border-radius: 10px;
    }
    .controls input {
      padding: 10px;
      border-radius: 5px;
      margin: 5px;
    }
 .summary-box {
  display: flex;
  gap: 15px;
  align-items: center;
  color: #f4e733;
  font-weight: bold;
}    
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.search-group {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.search-group select,
.search-group input,
.search-group button.clear-btn {
  height: 40px;
  padding: 8px 12px;
  font-size: 15px;
  border-radius: 6px;
  border: none;
  box-sizing: border-box;
  flex: 1;
  min-width: 140px;
}
.export-buttons {
  display: flex;
  flex-direction: row;
  gap: 10px;
}
    .controls .summary-box {
      display: flex;
      gap: 15px;
      align-items: center;
      color: #f4e733;
      font-weight: bold;
      margin: 5px;
    }
    button.export {
      background: #f4e733;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #f4e733;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #f4e733;
    }
nav {
  display: flex;
  justify-content: center; 
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  width: 100%;
  background-color: #111;
  border-bottom: 3px solid #f4e733;
  border-top: 1px solid #f4e733;
}
nav button,
.dropdown > button {
  font-size: 19px;
  padding: 13px 25px;
  margin: 0 15px;    
  border-radius: 8px;
  background-color: #111;
  color: #f4e733;
  border: none;
  text-align: center;     
  min-width: 100px;     
}
    .dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #222;
  min-width: 120px;
  z-index: 1;
  border: 1px solid #f4e733;
}

.dropdown-content a {
  color: #f4e733;
  padding: 10px 14px;
  display: block;
  text-align: right;
  cursor: pointer;
}

.dropdown:hover .dropdown-content {
  display: block;
}
nav button.active {
  background-color: #f4e733;
  color: black !important;
}
    .download-icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background: black;
  clip-path: polygon(50% 0%, 100% 50%, 75% 50%, 75% 100%, 25% 100%, 25% 50%, 0% 50%);
  margin-left: 5px;
  vertical-align: middle;
}
    .hidden {
  display: none;
}
           footer {
      background-color: #111;
      color: white;
      text-align: center;
      padding: 20px;
      border-top: 3px solid #f4e733;
      font-size: 14px;
    }

    .social-icons a {
      color: white;
      margin: 0 8px;
      font-size: 20px;
    }
    #datePicker {
  background: white;
  color: black;
  border: none;
  padding: 10px;
  border-radius: 5px;
}
    @media (max-width: 768px) {
 .header-right {
    padding: 10px 10px;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .header-info {
    display: block;
    text-align: center;
  }

  .header-info .arabic-name {
    font-size: 16px;
  }

  .header-info .english-name {
    font-size: 12px;
  }

  .header-right .divider {
    height: 45px;
    width: 1.5px;
    background-color: #f4e733;
  }

  img.logo {
    height: 50px !important;
    max-height: 50px !important;
  }
  nav {
    justify-content: center;
    margin: 0 auto;
    width: 100%;
    max-width: 100%;
  }

  nav button, .dropdown > button {
    flex: 1;
    text-align: center;
  }

  .container {
    padding: 12px;
    margin: 10px auto;
    width: 95%;
  }

  .title {
    font-size: 18px;
    margin-top: 15px;
    margin-bottom: 17px;
    line-height: 1.4;
  }

  .filter-bar {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .search-group {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
    width: 100%;
  }

  .search-group select,
  .search-group input,
  .search-group button.clear-btn,
  #datePicker {
    width: 100%;
    padding: 10px;
    font-size: 15px;
    border-radius: 6px;
    box-sizing: border-box;
  }

  .export-buttons {
    flex-direction: row;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
  }

  .summary-box {
    text-align: center;
    font-size: 14px;
  }
      
table {
  display: block;
  overflow-x: auto;
  font-size: 13px;
  width: 100%;
}
  th, td {
    padding: 6px;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }
      .hidden {
  display: none;
}
  footer {
  text-align: center;
  padding: 15px 10px;
}

footer p {
  margin-bottom: 10px;
  font-size: 13px;
}
  .social-icons {
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  .social-icons a {
    font-size: 18px;
    padding: 8px;
  }
}
  </style>
</head>
<body>
  <header class="header-container">
  <div class="header-right">
    <img src="Picture3.png" alt="شعار الشارقة" class="logo">
    <div class="divider"></div>
    <img src="logo.png" alt="شعار نادي كلباء" class="logo">
    <div class="header-info">
      <div class="arabic-name">نادي كلباء الرياضي الثقافي</div>
      <div class="english-name">KALBA SPORTS & CULTURAL CLUB</div>
    </div>
  </div>
</header>

<nav>
  <div class="dropdown">
    <button>العام ▼</button>
    <div class="dropdown-content">
      <a onclick="filterData('day')">اليوم</a>
      <a onclick="filterData('week')">هذا الأسبوع</a>
      <a onclick="filterData('month')">هذا الشهر</a>
    </div>
  </div>
  <button onclick="showStats()">الإحصائيات</button>
  <button onclick="showActivities()">الأنشطة</button>
</nav>


<div class="container" id="mainView">
  <div class="title" style="color: #f4e733; text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 25px;">
    حضور صيف الشارقة الرياضي - عطلتنا غير
  </div>

  <div class="controls">

<div class="filter-bar">
  <div class="search-group">
    <select onchange="showFilterOptions(this.value)">
      <option value="">🔍 بحث حسب...</option>
      <option value="name">الاسم</option>
      <option value="id">المعرّف</option>
      <option value="staff">الموظف</option>
      <option value="activity">النشاط</option>
    </select>

    <input id="filter-name" class="hidden" placeholder="أدخل الاسم..." onkeyup="filterTable()">
    <input id="filter-id" class="hidden" placeholder="أدخل المعرف..." onkeyup="filterTable()">
    <select id="filter-staff" class="hidden" onchange="filterTable()"></select>
    <select id="filter-activity" class="hidden" onchange="filterTable()"></select>

    <input type="date" id="datePicker" onchange="filterByDate()" />
    <button onclick="clearFilters()" class="clear-btn">مسح</button>
  </div>

  <div class="export-buttons">
    <button class="export" onclick="exportToExcel()">
      <span class="download-icon"></span> Excel
    </button>
    <button class="export" onclick="exportToPDF()">
      <span class="download-icon"></span> PDF
    </button>
  </div>
</div>

    <div class="summary-box">
      <span id="summary">إجمالي الحضور: 0</span>
      <span id="filteredSummary"></span>
    </div>
  </div>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>الوقت</th>
          <th>الاسم وولي الأمر</th>
          <th>المعرف</th>
          <th>الموظف</th>
          <th>النشاط</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  <div id="todayStats" style="background:#222; padding:20px; border-radius:10px; margin-top:20px; color:#f4e733">
  <h3 style="margin-bottom:15px;">إحصاءات اليوم:</h3>
  <div id="staffToday"></div>
  <div id="timingToday" style="margin-top:10px;"></div>
</div>

</div>


  <div class="container" id="statsView" style="display: none;">
    <h2 style="color:#f4e733; text-align:center">إحصائيات الحضور</h2>
    <canvas id="pieStaff" height="200"></canvas>
    <canvas id="earlyLate" height="200"></canvas>
    <canvas id="attendanceChart" height="200"></canvas>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxij6xIH_fypPRhklqQKURq-7xB5RJ3sC5dCBfwj4sJBjqnfXde1ncFrhCpDy04zuZW6g/exec';
    let allData = [], chart;

function populateDropdowns() {
  const activities = new Set();
  const staff = new Set();

  allData.forEach(row => {
    if (row["Activity"]) activities.add(row["Activity"]);
    if (row["Scanned By"]) staff.add(row["Scanned By"]);
  });

  const activitySelect = document.getElementById("filter-activity");
  activitySelect.innerHTML = '<option value="">اختر النشاط</option>';
  [...activities].forEach(act => {
    const opt = document.createElement("option");
    opt.value = act;
    opt.textContent = act;
    activitySelect.appendChild(opt);
  });

  const staffSelect = document.getElementById("filter-staff");
  staffSelect.innerHTML = '<option value="">اختر الموظف</option>';
  [...staff].forEach(stf => {
    const opt = document.createElement("option");
    opt.value = stf;
    opt.textContent = stf;
    staffSelect.appendChild(opt);
  });
}
    async function fetchData() {
      const res = await fetch(scriptURL);
      allData = await res.json();

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("datePicker").value = today;
      populateDropdowns();
    }

    function setActiveNav(type) {
  const buttons = document.querySelectorAll("nav a"); 
  buttons.forEach(btn => btn.classList.remove("active"));

  const map = { day: 0, week: 1, month: 2 };
  if (map[type] !== undefined) buttons[map[type]].classList.add("active");
}


function filterData(type) {
  setActiveNav(type);
  document.getElementById("mainView").style.display = "block";
  document.getElementById("statsView").style.display = "none";

  const now = new Date();
  const seen = new Set(); 

  let filtered = allData.filter(row => {
    const d = new Date(row["Timestamp"]);

    let dateMatch = false;
    if (type === 'day') dateMatch = d.toDateString() === now.toDateString();
    else if (type === 'week') {
      const start = new Date(now); start.setDate(now.getDate() - 7);
      dateMatch = d >= start && d <= now;
    }
    else if (type === 'month') dateMatch = d.getMonth() === now.getMonth();
    else dateMatch = true;

    if (!dateMatch) return false;

    const key = `${row["ID"]}_${d.toDateString()}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  renderTable(filtered);
}

function filterByDate() {
  const selectedDate = document.getElementById("datePicker").value;
  if (!selectedDate) return;

  const filtered = allData.filter(row => {
    const rowDate = new Date(row["Timestamp"]).toISOString().split("T")[0];
    return rowDate === selectedDate;
  });

  document.getElementById("mainView").style.display = "block";
  document.getElementById("statsView").style.display = "none";
  renderTable(filtered);
}
    function showStats() {
      document.getElementById("mainView").style.display = "none";
      document.getElementById("statsView").style.display = "block";
      const staffCounts = {}, early = { early: 0, late: 0 };

      allData.forEach(row => {
        const name = row["Scanned By"] || "غير معروف";
        staffCounts[name] = (staffCounts[name] || 0) + 1;
        const hour = new Date(row["Timestamp"]).getHours();
        const min = new Date(row["Timestamp"]).getMinutes();
        const time = hour * 60 + min;
        if (time < (17 * 60 + 11)) early.early++;
        else early.late++;
      });

      new Chart(document.getElementById("pieStaff").getContext("2d"), {
        type: 'pie',
        data: {
          labels: Object.keys(staffCounts),
          datasets: [{
            data: Object.values(staffCounts),
            backgroundColor: ['#f4e733', '#ffbb00', '#ffaa00', '#ccaa00', '#999900']
          }]
        }
      });

      new Chart(document.getElementById("earlyLate").getContext("2d"), {
        type: 'bar',
        data: {
          labels: ['حضور بالوقت', 'حضور متأخر'],
          datasets: [{
            data: [early.early, early.late],
            backgroundColor: ['#66cc66', '#cc3333']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      const perDay = {};
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(row["Timestamp"]).toLocaleString('ar-EG')}</td>
          <td>${row["Child Name"]} ${row["Parent"]}</td>
          <td>${row["ID"]}</td>
          <td>${row["Scanned By"]}</td>
          <td>${row["Activity"] || ""}</td>`;
        tbody.appendChild(tr);
        const day = new Date(row["Timestamp"]).toLocaleDateString('ar-EG');
        perDay[day] = (perDay[day] || 0) + 1;
      });
      document.getElementById("summary").innerText = `إجمالي الحضور: ${data.length}`;
      document.getElementById("filteredSummary").innerText = "";
      updateChart(perDay);

const staffToday = {};
let early = 0, late = 0;
data.forEach(row => {
  const name = row["Scanned By"] || "غير معروف";
  staffToday[name] = (staffToday[name] || 0) + 1;

  const time = new Date(row["Timestamp"]);
const hours = time.getHours();
const minutes = time.getMinutes();
const totalMinutes = hours * 60 + minutes;

//  قبل 17:11
if (totalMinutes < (17 * 60 + 11)) early++;
else late++;
});

const staffList = Object.entries(staffToday)
  .map(([name, count]) => `${name}: ${count}`)
  .join("<br>");

document.getElementById("staffToday").innerHTML = `<strong>حسب الموظف:</strong><br>${staffList}`;
document.getElementById("timingToday").innerHTML = `<strong>حسب الوقت:</strong><br>بالوقت: ${early} | متأخر: ${late}`;
    }

function filterTable() {
  const name = document.getElementById("filter-name").value.toLowerCase();
  const id = document.getElementById("filter-id").value.toLowerCase();
  const staff = document.getElementById("filter-staff").value.toLowerCase();
  const activity = document.getElementById("filter-activity").value.toLowerCase();

  const rows = document.querySelectorAll("#attendanceTable tbody tr");

  let visibleCount = 0;
  rows.forEach(row => {
    const nameCell = row.cells[1].innerText.toLowerCase();
    const idCell = row.cells[2].innerText.toLowerCase();
    const staffCell = row.cells[3].innerText.toLowerCase();
    const activityCell = row.cells[4]?.innerText.toLowerCase() || "";

    const match =
      nameCell.includes(name) &&
      idCell.includes(id) &&
      staffCell.includes(staff) &&
      activityCell.includes(activity);

    row.style.display = match ? "" : "none";
    if (match) visibleCount++;
  });

  document.getElementById("filteredSummary").innerText =
    (name || id || staff || activity) ? `عدد النتائج المطابقة: ${visibleCount}` : "";
}

function clearFilters() {
  // Reset all inputs
  document.getElementById("filter-name").value = "";
  document.getElementById("filter-id").value = "";
  document.getElementById("filter-staff").value = "";
  document.getElementById("filter-activity").value = "";
    renderTable(allData);
}
    function exportToExcel() {
      const wb = XLSX.utils.table_to_book(document.getElementById("attendanceTable"));
      XLSX.writeFile(wb, "attendance.xlsx");
    }

function exportToPDF() {
    const rows = document.querySelectorAll("#attendanceTable tbody tr");
  if (rows.length === 0) {
    alert("لا يوجد بيانات لتصديرها إلى PDF");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  const table = document.querySelector("#attendanceTable");

  table.style.overflow = "visible";

  html2canvas(table, {
    scale: 2,
    backgroundColor: "#000000",
    useCORS: true
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let position = 10;
    let heightLeft = imgHeight;

    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      doc.addPage();
      doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    doc.save("attendance.pdf");
  });
}  

    function updateChart(dayCounts) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(dayCounts),
          datasets: [{
            label: 'عدد الحضور اليومي',
            data: Object.values(dayCounts),
            backgroundColor: '#f4e733',
            borderColor: '#000',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function showActivities() {
  document.getElementById("mainView").style.display = "block";
  document.getElementById("statsView").style.display = "none";

  const filtered = allData.filter(row => row["Activity"] && row["Activity"] !== "");
  renderTable(filtered);
}

function showFilterOptions(value) {
  document.getElementById("filter-name").classList.add("hidden");
  document.getElementById("filter-id").classList.add("hidden");
  document.getElementById("filter-staff").classList.add("hidden");
  document.getElementById("filter-activity").classList.add("hidden");

  if (value === "name") document.getElementById("filter-name").classList.remove("hidden");
  else if (value === "id") document.getElementById("filter-id").classList.remove("hidden");
  else if (value === "staff") document.getElementById("filter-staff").classList.remove("hidden");
  else if (value === "activity") document.getElementById("filter-activity").classList.remove("hidden");
}
window.onload = () => {
  fetchData().then(() => filterData('day'));
};
  </script>
  <footer>
  <p>© 2025 نادي كلباء الرياضي الثقافي - جميع الحقوق محفوظة</p>
    <p style="font-size: 14px; color: #aaa; margin-top: -10px;">تم التطوير بواسطة روند أحمد الضمور</p>
  <div class="social-icons">
    <a href="https://facebook.com/Kalbasc1" target="_blank"><i class="fab fa-facebook-f"></i></a>
    <a href="https://instagram.com/kalbasc" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://x.com/Kalba_sc" target="_blank"><i class="fab fa-twitter"></i></a>
    <a href="https://youtube.com/@kalbasc" target="_blank"><i class="fab fa-youtube"></i></a>
    <a href="https://tiktok.com/@kalbasc" target="_blank"><i class="fab fa-tiktok"></i></a>
  </div>
</footer>
</body>
</html>
