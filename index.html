<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
    <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Ù„ÙˆØ­Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø®ÙŠÙ… Ø§Ù„ØµÙŠÙÙŠ - Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic.ttf') format('truetype');
    }
    body {
      font-family: 'NotoKufiArabic', sans-serif;
      background: url('black_and_yellow_grunge_background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      margin: 0;
      padding: 0;
    }
.header-container {
  width: 100%;
  background: #111;
  border-bottom: 2px solid #f4e733;
}
.header-right {
  width: 100%;
  max-width: 1170px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 20px 42px;
  background-color: #111;
  color: white;
  box-sizing: border-box;
}
.header-right img.logo {
  height: 70px;
}
.divider {
  width: 1.5px;
  height: 65px;
  background-color: #f4e733;
}
.header-info {
  text-align: center;
}
.arabic-name {
  font-weight: bold;
  font-size: 20px;
      font-weight: bold;
}
.english-name {
  font-size: 14px;
  color: #f4e733;
}
    .dropdown-content a:hover {
  background-color: #f4e733;
  color: black;
}
    .filter-btn {
  background-color: #111;
  color: #f4e733;
  border: 1px solid #f4e733;
  padding: 10px 18px;
  margin: 5px;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

.filter-btn.active {
  background-color: #f4e733;
  color: black;
}

    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 10px;
      margin-top: 30px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 15px;
      border-radius: 10px;
    }
    .controls input {
      padding: 10px;
      border-radius: 5px;
      margin: 5px;
    }
 .summary-box {
  display: flex;
  gap: 15px;
  align-items: center;
  color: #f4e733;
  font-weight: bold;
}    
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.search-group {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.search-group select,
.search-group input,
.search-group button.clear-btn {
  height: 40px;
  padding: 8px 12px;
  font-size: 15px;
  border-radius: 6px;
  border: none;
  box-sizing: border-box;
  flex: 1;
  min-width: 140px;
}
.export-buttons {
  display: flex;
  flex-direction: row;
  gap: 10px;
}
    .controls .summary-box {
      display: flex;
      gap: 15px;
      align-items: center;
      color: #f4e733;
      font-weight: bold;
      margin: 5px;
    }
    button.export {
      background: #f4e733;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #f4e733;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #f4e733;
    }
nav {
  display: flex;
  justify-content: center; 
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  width: 100%;
  background-color: #111;
  border-bottom: 3px solid #f4e733;
  border-top: 1px solid #f4e733;
}
nav button,
.dropdown > button {
  font-size: 19px;
  padding: 13px 25px;
  margin: 0 15px;    
  border-radius: 8px;
  background-color: #111;
  color: #f4e733;
  border: none;
  text-align: center;     
  min-width: 100px;     
}
    .dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #222;
  min-width: 120px;
  z-index: 1;
  border: 1px solid #f4e733;
}

.dropdown-content a {
  color: #f4e733;
  padding: 10px 14px;
  display: block;
  text-align: right;
  cursor: pointer;
}

.dropdown:hover .dropdown-content {
  display: block;
}
nav button.active {
  background-color: #f4e733;
  color: black !important;
}
    .download-icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background: black;
  clip-path: polygon(50% 0%, 100% 50%, 75% 50%, 75% 100%, 25% 100%, 25% 50%, 0% 50%);
  margin-left: 5px;
  vertical-align: middle;
}
    .dropdown-content a.active {
  background-color: #f4e733;
  color: black !important;
}
    .filter-bar {
  max-width: 1200px;
  margin: auto;
}

           footer {
      background-color: #111;
      color: white;
      text-align: center;
      padding: 20px;
      border-top: 3px solid #f4e733;
      font-size: 14px;
    }

    .social-icons a {
      color: white;
      margin: 0 8px;
      font-size: 20px;
    }
    #datePicker {
  background: white;
  color: black;
  border: none;
  padding: 10px;
  border-radius: 5px;
}

    body { font-family: 'Arial', sans-serif; background-color: #000; color: white; margin: 0; padding: 0; }
    nav button.active { background-color: #f4e733; color: black !important; }
    .filter-btn.active { background-color: #f4e733; color: black; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #f4e733; padding: 10px; text-align: center; }
    th { background-color: #333; color: #f4e733; }

    

    
    @media (max-width: 768px) {
 .header-right {
    padding: 10px 10px;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .header-info {
    display: block;
    text-align: center;
  }

  .header-info .arabic-name {
    font-size: 16px;
  }

  .header-info .english-name {
    font-size: 12px;
  }

  .header-right .divider {
    height: 45px;
    width: 1.5px;
    background-color: #f4e733;
  }

  img.logo {
    height: 50px !important;
    max-height: 50px !important;
  }
  nav {
    justify-content: center;
    margin: 0 auto;
    width: 100%;
    max-width: 100%;
  }

  nav button, .dropdown > button {
    flex: 1;
    text-align: center;
  }

  .title {
    font-size: 18px;
    margin-top: 15px;
    margin-bottom: 17px;
    line-height: 1.4;
  }
.controls {
  display: flex;
  flex-direction: column;
  align-items: center; 
  gap: 15px;
  background: #222;
  padding: 20px;
  border-radius: 10px;
  width: 100%;
  box-sizing: border-box;
}

.filter-bar {
  width: 100%;
  max-width: 600px;  
  margin: 0 auto;      
}

.search-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-sizing: border-box;
}

.search-group select,
.search-group input,
.search-group button,
#datePicker {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
}

.clear-btn {
  background-color: #f4e733;
  color: black;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  padding: 10px;
}

.export-buttons {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  gap: 10px;
}

.export-buttons .export {
  flex: 1;
  background-color: #f4e733;
  border: none;
  color: black;
  font-weight: bold;
  font-size: 14px;
  padding: 10px;
  border-radius: 8px;
}
      
  .summary-box {
    text-align: center;
    font-size: 14px;
  }
      
table {
  display: block;
  overflow-x: auto;
  font-size: 13px;
  width: 100%;
}
  th, td {
    padding: 6px;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }
    
  footer {
  text-align: center;
  padding: 15px 10px;
}

footer p {
  margin-bottom: 10px;
  font-size: 13px;
}
  .social-icons {
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  .social-icons a {
    font-size: 18px;
    padding: 8px;
  }
}
  </style>
</head>
<body>
  <header class="header-container">
  <div class="header-right">
    <img src="Picture3.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø¬Ù„Ø³ Ø§Ù„Ø´Ø§Ø±Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ" class="logo">
    <div class="divider"></div>
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ" class="logo">
    <div class="header-info">
      <div class="arabic-name">Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</div>
      <div class="english-name">KALBA SPORTS & CULTURAL CLUB</div>
    </div>
  </div>
</header>
  
  <nav>
    <button onclick="showView('general')">Ø§Ù„Ø¹Ø§Ù…</button>
    <button onclick="showView('stats')">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button onclick="showView('activity')">Ø§Ù„Ø£Ù†Ø´Ø·Ø©</button>
    <div id="dateFilters">
      <button onclick="filterData('day')" class="filter-btn">Ø§Ù„ÙŠÙˆÙ…</button>
      <button onclick="filterData('week')" class="filter-btn">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
      <button onclick="filterData('month')" class="filter-btn">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
  </nav>


<div class="container" id="generalView">
  <div class="title" style="color: #f4e733; text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 25px;">
    Ø­Ø¶ÙˆØ± ØµÙŠÙ Ø§Ù„Ø´Ø§Ø±Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ - Ø¹Ø·Ù„ØªÙ†Ø§ ØºÙŠØ±
  </div>

  <div class="controls">
    
<div class="filter-bar">
  <div class="search-group">
    <select onchange="showFilterOptions(this.value)">
      <option value="">ğŸ” Ø¨Ø­Ø« Ø­Ø³Ø¨...</option>
      <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
      <option value="id">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</option>
      <option value="staff">Ø§Ù„Ù…ÙˆØ¸Ù</option>
      <option value="activity">Ø§Ù„Ù†Ø´Ø§Ø·</option>
    </select>

    <input id="filter-name" class="hidden" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterTable()">
    <input id="filter-id" class="hidden" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù..." onkeyup="filterTable()">
    <select id="filter-staff" class="hidden" onchange="filterTable()"></select>
    <select id="filter-activity" class="hidden" onchange="filterTable()"></select>

    <input type="date" id="datePicker" onchange="filterByDate()" />
    <button onclick="clearFilters()" class="clear-btn">Ù…Ø³Ø­</button>
  </div>

  <div class="export-buttons">
    <button class="export" onclick="exportToExcel()">
      <span class="download-icon"></span> Excel
    </button>
    <button class="export" onclick="exportToPDF()">
      <span class="download-icon"></span> PDF
    </button>
  </div>
</div>

    <div class="summary-box">
      <span id="summary">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±: 0</span>
      <span id="filteredSummary"></span>
    </div>
  </div>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø§Ø³Ù… ÙˆÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
          <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
          <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
          <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  
  <div id="loading" style="text-align:center;color:#f4e733;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <div id="todayStats" style="background:#222; padding:20px; border-radius:10px; margin-top:20px; color:#f4e733">
  <h3 style="margin-bottom:15px;">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…:</h3>
  <div id="staffToday"></div>
  <div id="timingToday" style="margin-top:10px;"></div>
</div>

</div>

  <div id="activityView" class="hidden">
    <h3>Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h3>
    <table id="activityTable"><thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="container" id="statsView" style="display: none;">
    <h2 style="color:#f4e733; text-align:center">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
    <canvas id="pieStaff" height="200"></canvas>
    <canvas id="earlyLate" height="200"></canvas>
    <canvas id="attendanceChart" height="200"></canvas>
  </div>

   <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxij6xIH_fypPRhklqQKURq-7xB5RJ3sC5dCBfwj4sJBjqnfXde1ncFrhCpDy04zuZW6g/exec';
    let allData = [], filteredData = [];

async function fetchData() {
  const res = await fetch(scriptURL);
  const raw = await res.json();
  allData = raw.filter(e => e.ID); // remove empty IDs

  const idMap = new Map();

  // Group all entries by ID
  raw.forEach(entry => {
    const id = entry.ID;
    if (!idMap.has(id)) idMap.set(id, []);
    idMap.get(id).push(entry);
  });

  // Process logic for unique attendance per ID
  const uniqueFirstScan = [];
  idMap.forEach(entries => {
    const generalEntry = entries.find(e => (e.General || '').includes('âœ”ï¸'));
    if (generalEntry) {
      uniqueFirstScan.push(generalEntry);
    } else {
      // no general? fallback to first activity
      const firstActivity = entries.find(e => e.Activity && e.Activity.trim() !== '');
      if (firstActivity) uniqueFirstScan.push(firstActivity);
    }
  });

  filteredData = [...uniqueFirstScan];
  renderGeneralTable(filteredData);
}

    function showView(view) {
      ['generalView', 'statsView', 'activityView'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(view + 'View').classList.remove('hidden');
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`nav button[onclick="showView('${view}')"]`).classList.add('active');
      if (view === 'activity') renderActivityTable();
      if (view === 'stats') showStats();
    }

function filterData(type) {
  const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Dubai" }));
  let cutoff;

  if (type === 'day') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if (type === 'week') cutoff = new Date(now.setDate(now.getDate() - now.getDay()));
  if (type === 'month') cutoff = new Date(now.getFullYear(), now.getMonth(), 1);

  filteredData = allData.filter(row => {
    const localDate = new Date(new Date(row.Timestamp).toLocaleString("en-US", { timeZone: "Asia/Dubai" }));
    return localDate >= cutoff;
  });

  renderGeneralTable(filteredData);
  document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
  document.querySelector(`.filter-btn[onclick="filterData('${type}')"]`).classList.add("active");
}
     
function formatLocalTime(timestamp) {
  if (!timestamp) return "";
  const date = new Date(timestamp);
  return date.toLocaleString("ar-EG", { timeZone: "Asia/Dubai", hour12: true });
}

    function renderGeneralTable(data) {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      
  if (data.length === 0) {
  const row = document.createElement("tr");
  row.innerHTML = `<td colspan="5" style="color:#f4e733">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ±</td>`;
  tbody.appendChild(row);
}
      data.forEach(entry => {
        const row = document.createElement("tr");
  row.innerHTML = `
  <td>${new Date(entry["Timestamp"]).toLocaleString("en-US", { timeZone: "Asia/Dubai" })}</td>
  <td>${entry["Child Name"] || ""}${entry["Parent"] ? " " + entry["Parent"] : ""}</td>
  <td>${entry["ID"]}</td>
  <td>${entry["Scanned By"]}</td>
  <td>${entry["General"] || "" || entry["Activity"] || ""}</td>
`;
        tbody.appendChild(row);
      });
  document.getElementById("summary").textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±: ${data.length}`;
  document.getElementById("todayStats").style.display = data.length ? "block" : "none";
  document.getElementById("loading").style.display = "none";
    }

    function filterTable() {
      const val = document.getElementById("searchInput").value.toLowerCase();
      const rows = filteredData.filter(d => (d["Child Name"] + d["ID"]).toLowerCase().includes(val));
      renderGeneralTable(rows);
    }

    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");
      XLSX.writeFile(wb, "attendance.xlsx");
    }

    function exportToPDF() {
      html2canvas(document.querySelector("#attendanceTable")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 10, 10, 190, 0);
        pdf.save("attendance.pdf");
      });
    }

    function renderActivityTable() {
      const tbody = document.querySelector("#activityTable tbody");
      tbody.innerHTML = "";
      const activities = allData.filter(e => e.Activity);
      activities.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${entry["Timestamp"]}</td><td>${entry["Child Name"]}</td><td>${entry["ID"]}</td><td>${entry["Scanned By"]}</td><td>${entry["Activity"]}</td>`;
        tbody.appendChild(row);
      });
    }

    function showStats() {
      const ctx = document.getElementById('attendanceChart').getContext('2d');
      const counts = {};
      filteredData.forEach(e => { counts[e["Scanned By"]] = (counts[e["Scanned By"]] || 0) + 1 });
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±', data: Object.values(counts), backgroundColor: '#f4e733' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }
     
function filterByDate() {
  const selectedDate = document.getElementById("datePicker").value;
  if (!selectedDate) return;

  const dateOnly = new Date(selectedDate).toISOString().split("T")[0];

  const results = allData.filter(row => {
    const rowDate = new Date(row.Timestamp).toISOString().split("T")[0];
    return rowDate === dateOnly;
  });

  filteredData = results;
  renderGeneralTable(filteredData);
  document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
}

window.onload = () => fetchData().then(() => {
  filterData('day');
  showView('general');
});

   </script>
  
  <footer>
  <p>Â© 2025 Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
    <p style="font-size: 14px; color: #aaa; margin-top: -10px;">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø±ÙˆÙ†Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¶Ù…ÙˆØ±</p>
  <div class="social-icons">
    <a href="https://facebook.com/Kalbasc1" target="_blank"><i class="fab fa-facebook-f"></i></a>
    <a href="https://instagram.com/kalbasc" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://x.com/Kalba_sc" target="_blank"><i class="fab fa-twitter"></i></a>
    <a href="https://youtube.com/@kalbasc" target="_blank"><i class="fab fa-youtube"></i></a>
    <a href="https://tiktok.com/@kalbasc" target="_blank"><i class="fab fa-tiktok"></i></a>
  </div>
</footer>
</body>
</html>
